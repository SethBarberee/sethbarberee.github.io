<!DOCTYPE html>
<html lang="en" class="html" data-theme="dark"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>
    
      LSP and Pokemon Decomp
    
  </title>

  <!-- Begin Jekyll SEO tag v2.7.3 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="LSP and Pokemon Decomp" />
<meta name="author" content="Seth Barberee" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Most people tend to use VS Code for Pokemon decomp and it works very nicely for them with clangd all set up and tools. However, I’m different. I like to use neovim and just doing clangd normally will give errors. Why? Well, you need to generate the compile_commands.json first. So, using a tool called compiledb, I’ll do that now for pokeemerald." />
<meta property="og:description" content="Most people tend to use VS Code for Pokemon decomp and it works very nicely for them with clangd all set up and tools. However, I’m different. I like to use neovim and just doing clangd normally will give errors. Why? Well, you need to generate the compile_commands.json first. So, using a tool called compiledb, I’ll do that now for pokeemerald." />
<link rel="canonical" href="https://www.abhinavsaxena.com/moonwalk/lsp-and-pokemon-decomp" />
<meta property="og:url" content="https://www.abhinavsaxena.com/moonwalk/lsp-and-pokemon-decomp" />
<meta property="og:site_name" content="Seth Barberee" />
<meta property="og:image" content="https://soopr.xyz/images/card?url=https://www.abhinavsaxena.com/moonwalk/lsp-and-pokemon-decomp" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-02-12T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="og:image" content="https://soopr.xyz/images/card?url=https://www.abhinavsaxena.com/moonwalk/lsp-and-pokemon-decomp" />
<meta property="twitter:title" content="LSP and Pokemon Decomp" />
<meta name="twitter:site" content="@s_barberee" />
<meta name="twitter:creator" content="@Seth Barberee" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Seth Barberee"},"description":"Most people tend to use VS Code for Pokemon decomp and it works very nicely for them with clangd all set up and tools. However, I’m different. I like to use neovim and just doing clangd normally will give errors. Why? Well, you need to generate the compile_commands.json first. So, using a tool called compiledb, I’ll do that now for pokeemerald.","url":"https://www.abhinavsaxena.com/moonwalk/lsp-and-pokemon-decomp","@type":"BlogPosting","headline":"LSP and Pokemon Decomp","dateModified":"2023-02-12T00:00:00+00:00","datePublished":"2023-02-12T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.abhinavsaxena.com/moonwalk/lsp-and-pokemon-decomp"},"@context":"https://schema.org"}</script>
<script async defer data-soopr-token="" src="https://sdk.soopr.co/soopr.js"  ></script>
<!-- End Jekyll SEO tag -->

  <link type="application/atom+xml" rel="alternate" href="https://www.abhinavsaxena.com/moonwalk/feed.xml" title="Seth Barberee" />

  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="stylesheet" href="/assets/css/main.css" />
  
    <script type="text/javascript">
  window.addEventListener('load', themeChange);
  const currentTheme = localStorage.getItem('theme') ? localStorage.getItem('theme') : null;
  if (currentTheme)
    document.documentElement.setAttribute('data-theme', currentTheme);

  function themeChange() {
    let button = document.querySelector('.theme-toggle');

    button.addEventListener('click', function (e) {
      let currentTheme = document.documentElement.getAttribute('data-theme');
      if (currentTheme === 'dark') {
        transition();
        document.documentElement.setAttribute('data-theme', 'light');
        localStorage.setItem('theme', 'light');
      } else {
        transition();
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
      }
    });

    let transition = () => {
      document.documentElement.classList.add('transition');
      window.setTimeout(() => {
        document.documentElement.classList.remove('transition');
      }, 1000);
    }
  }
</script>


  
</head>
<body>
    <main class="page-content" aria-label="Content">
      <div class="w">
        <a href="/">home..</a>
<h1 class="post-title">LSP and Pokemon Decomp</h1>
<p class="post-date text-bold">
  
  
    <span class="text-upcase">February 2023</span>
  


</p>

<div class="soopr-btn"
   data-twitter="SooprCo"
>
</div>


  <div class="">
    
    <span class="tag">LSP</span>
    
    <span class="tag">nvim</span>
    
  </div>


<p>Most people tend to use VS Code for Pokemon decomp and it works very nicely for
them with clangd all set up and tools. However, I’m different. I like to use
neovim and just doing clangd normally will give errors. Why? Well, you need to
generate the <code class="language-plaintext highlighter-rouge">compile_commands.json</code> first. So, using a tool called
<code class="language-plaintext highlighter-rouge">compiledb</code>, I’ll do that now for pokeemerald.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>compiledb make
</code></pre></div></div>

<p>This will fix most of the previous errors because now, clangd sees the custom
compiler that Pokemon decompilations use. There are still some warnings and
errors. Mainly, with how the code sets graphics like:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="n">u32</span> <span class="n">gMonFrontPic_Ivysaur</span><span class="p">[]</span> <span class="o">=</span> <span class="n">INCBIN_U32</span><span class="p">(</span><span class="s">"graphics/pokemon/ivysaur/anim_front.4bpp.lz"</span><span class="p">);</span>
</code></pre></div></div>

<p>We can tweak <code class="language-plaintext highlighter-rouge">.clangd</code> with the following config:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CompileFlags:
    Remove: [-mthumb-interwork, -fhex-asm]
    Add: [--include=include/global.h, --include=include/gba/types.h, -Wno-pointer-sign, -D __APPLE__] # include GBA global to fix type errors, silence pointer warnings for text, and use define to silence other warnings
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">-D __APPLE__</code> tricks the compiler to take an optimized route in the code and
use the workarounds that VS Code uses.</p>

<p><code class="language-plaintext highlighter-rouge">--include=include/global.h, --include=include/gba/types.h, -Wno-pointer-sign</code>
adds in our custom types and other gba/pokemon specific things to <code class="language-plaintext highlighter-rouge">clang</code>.</p>

<p><code class="language-plaintext highlighter-rouge">-mthumb-interwork, -fhex-asm</code> these flags cause some issues with <code class="language-plaintext highlighter-rouge">clang</code> so
we’ll remove it. It won’t make a difference in our diagnostics/warnings.</p>

<h3 id="extra-credit">Extra Credit</h3>
<p>If you go down the hole of scripting in pokeemerald, there is an interesting
project called poryscript, which can replace normal scripting. It is a
different language and has an LSP server! So, install poryscrip-pls (however
you do it for your OS). 
Now, we need to make neovim call poryscript-pls when it enters the buffer. We
can do this via a custom nvim-lspconfig configuration. I created the following
in <code class="language-plaintext highlighter-rouge">lua/lspconfig/server_configurations/poryscript_lsp.lua</code>.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">util</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">'lspconfig.util'</span>

<span class="k">return</span> <span class="p">{</span>
    <span class="n">default_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"poryscript-pls"</span> <span class="p">},</span>
        <span class="n">filetypes</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'pory'</span> <span class="p">},</span>
        <span class="n">root_dir</span> <span class="o">=</span> <span class="n">util</span><span class="p">.</span><span class="n">find_git_ancestor</span><span class="p">,</span>
        <span class="n">single_file_support</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">docs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s">[[
https://github.com/huderlem/poryscript-pls

Language server for poryscript (a high level scripting language for pokemon decompilation projects)

 ]]</span>      <span class="p">,</span>
        <span class="n">default_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">root_dir</span> <span class="o">=</span> <span class="s">[[util.find_git_ancestor]]</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Nice, so now this is registered in <code class="language-plaintext highlighter-rouge">nvim-lspconfig</code> and we can call the
following in our config to autostart the lsp on the buffer.</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lspconfig</span><span class="p">(</span><span class="s1">'poryscript_lsp'</span><span class="p">).</span><span class="n">setup</span><span class="p">()</span>
</code></pre></div></div>

<p>Check your <code class="language-plaintext highlighter-rouge">:LspInfo</code> and verify it’s attached. Now, it is working but we
don’t have any meaningful diagnostics/warnings yet because this LSP is a
little special and needs some special handlers. <code class="language-plaintext highlighter-rouge">poryscript-lsp</code> calls custom
methods that standard neovim doesn’t know yet. So, we’ll add them to our
config then:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">handlers</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">handlers</span><span class="p">[</span><span class="s2">"poryscript/getPoryscriptFiles"</span><span class="p">]</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">base_dir</span> <span class="o">=</span> <span class="n">vim</span><span class="p">.</span><span class="n">fn</span><span class="p">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="c1">-- TODO: search for all *pory files for this request</span>
    <span class="kd">local</span> <span class="n">files</span> <span class="o">=</span> <span class="n">vim</span><span class="p">.</span><span class="n">fn</span><span class="p">.</span><span class="n">expand</span><span class="p">(</span><span class="n">base_dir</span> <span class="o">..</span> <span class="s2">"/data/scripts/test2.pory"</span><span class="p">)</span>
    <span class="c1">--print(files)</span>
    <span class="kd">local</span> <span class="n">files_array</span> <span class="o">=</span> <span class="p">{</span> <span class="n">files</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">files_array</span>
<span class="k">end</span>

<span class="n">handlers</span><span class="p">[</span><span class="s2">"poryscript/getfileuri"</span><span class="p">]</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span>
    <span class="c1">--print("get file uri")</span>
    <span class="c1">--print(vim.inspect(result))</span>
    <span class="k">return</span> <span class="n">vim</span><span class="p">.</span><span class="n">uri_from_bufnr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">handlers</span><span class="p">[</span><span class="s2">"poryscript/readfile"</span><span class="p">]</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">bufnr</span> <span class="o">=</span> <span class="n">vim</span><span class="p">.</span><span class="n">uri_to_bufnr</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vim</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">nvim_buf_is_loaded</span><span class="p">(</span><span class="n">bufnr</span><span class="p">)</span> <span class="k">then</span>
        <span class="c1">-- NOTE: Read the lines in the buffer and then combine into a string since poryscript-pls expects a string</span>
        <span class="kd">local</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">vim</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">nvim_buf_get_lines</span><span class="p">(</span><span class="n">bufnr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">table.concat</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="s2">""</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">handlers</span><span class="p">[</span><span class="s2">"poryscript/readfs"</span><span class="p">]</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">bufnr</span> <span class="o">=</span> <span class="n">vim</span><span class="p">.</span><span class="n">uri_to_bufnr</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vim</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">nvim_buf_is_loaded</span><span class="p">(</span><span class="n">bufnr</span><span class="p">)</span> <span class="k">then</span>
        <span class="c1">-- NOTE: Read the lines in the buffer and then combine into a string since poryscript-pls expects a string</span>
        <span class="kd">local</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">vim</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">nvim_buf_get_lines</span><span class="p">(</span><span class="n">bufnr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">table.concat</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="s2">""</span>
    <span class="k">end</span>

<span class="k">end</span>

<span class="k">return</span> <span class="n">handlers</span>
</code></pre></div></div>

<p>Note, this isn’t exactly perfect noted by the TODO but this will get us some diagnostics now.</p>



        
          <button title="Toggle Theme" class="theme-toggle">
  <svg viewBox="0 0 32 32" width="24" height="24" fill="currentcolor">
    <circle cx="16" cy="16" r="14" fill="none" stroke="currentcolor" stroke-width="4"></circle>
    <path d="
             M 16 0
             A 16 16 0 0 0 16 32
             z">
    </path>
  </svg>
</button>

        
        <div class="credits">&copy;&nbsp;2023&nbsp;Seth Barberee
          &nbsp;
          •
          &nbsp;Powered by <a href="https://www.soopr.co" target="_blank" rel="noreferrer">Soopr</a>
          &nbsp;
          •
          &nbsp;Theme&nbsp; <a href="https://github.com/abhinavs/moonwalk" target="_blank" rel="noreferrer">Moonwalk</a>
        </div>
      </div>
    </main><script async defer data-soopr-token="" src="https://sdk.soopr.co/soopr.js"></script></body>
</html>
