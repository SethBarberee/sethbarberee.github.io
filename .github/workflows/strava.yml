name: Update Strava stats

on: 
    schedule:
      - cron: 25 17 * * 0-6
    workflow_dispatch:

env:
    CLIENT_ID: {{ secrets.CLIENT_ID }}
    CLIENT_SECRET: {{ secrets.CLIENT_SECRET }}

jobs:
    fetch_data:
        name: Update Strava stats
        runs-on: ubuntu-latest
        outputs:
          output1: ${{ steps.fetch.outputs.token }}


        steps:
          - name: Checkout 🛎️
            uses: actions/checkout@v3
            with:
              persist-credentials: false

          - name: OAUTH
            uses: JamesIves/fetch-api-data-action@v2
            with:
              token-endpoint: https://www.strava.com/api/v3/oauth/token
              token-configuration: '{ "method": "POST", "body": {"client_id": "$CLIENT_ID", "client_secret": "$CLIENT_SECRET"} }'
              endpoint: https://www.strava.com/api/v3/athlete/activities
              configuration: '{ "method": "GET", "headers": {"Authorization": "Bearer {{{ data.access_token }}}"} }'

          - name: Set auth token
            run: echo "TOKEN={{{ data.access_token }}}" >> "$GITHUB_ENV"

          - name: filter_runs
            run: python ./extract-runs.py
