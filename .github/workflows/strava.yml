name: Update Strava stats

on: 
    schedule:
      - cron: 25 17 * * 0-6
    workflow_dispatch:
    
jobs:
    fetch_data:
        name: Update Strava stats
        runs-on: ubuntu-latest
        outputs:
          output1: ${{ steps.fetch.outputs.token }}

        steps:
          - name: Checkout 🛎️
            uses: actions/checkout@v3
            with:
              persist-credentials: false

          - name: OAUTH
            uses: JamesIves/fetch-api-data-action@releases/v1
            with:
              token-endpoint: https://www.strava.com/api/v3/oauth/token
              token-configuration: '{ "method": "POST", "body": {"client_id": "${{ secrets.client_id }}", "client_secret": "${{ secrets.client_secret }}"} }'
              endpoint: https://www.strava.com/api/v3/athlete/activities
              configuration: '{ "method": "GET", "headers": {"Authorization": "Bearer {{{ data.access_token }}}"} }'

          - id: fetch
            run: echo "token={{{ data.access_token }}}" >> "$GITHUB_OUTPUT"
    filter_runs:
        name: Filter runs
        runs-on: ubuntu-latest

        steps:
          - env:
              TOKEN: ${{needs.fetch.outputs.token}}
            run: python extract-runs.py
